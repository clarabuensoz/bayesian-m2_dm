---
title: "ProjetBayésien"
author: "orianebasso"
date: "2022-12-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Libraries 
```{r}
library(ggplot2)
library(R2jags)
```

## Data
```{r}

setwd("C:/Users/orian/OneDrive/Documents/bayesian-m2_dm")
data<-read.csv2("gopher.csv")
str(data)
data$prev<-as.numeric(data$prev)
data$Area<-as.numeric(data$Area)
data$Site<-as.factor(data$Site)
#data$year<-as.numeric(data$year)
data$density<-as.numeric(data$density)


```

## Part 1:  Lecture, exploration des données
Lisez les données, et assurez vous que les variables sont au bon format. Calculez des statistiques descriptives des données, et proposez des visualisations graphiques. Commentez ce que vous retenez de l'exploration des données.

```{r}
plot(density(data$prev))
hist(data$prev)
hist(data$shell)
plot(data$prev,data$shell)
plot(data$year,data$shell)
plot(data$prev,data$density)
```

## Part 2 : Models
### Data
```{r}
# Define numeric vector for the factor Site
Site<-as.numeric(data$Site)
# Define response variable : shell remains count
y<-data$shells
# Standardize explanatory variables
x<-(data$prev - mean(data$prev))/sd(data$prev)
#mean(x)
#sd(x)
#hist(x)

```
### Model 1
Y~ Poisson (T * u)
log (u) = a0 
Prior:
  a0~ N(0,sd=10)
  
```{r}
#Create dataframe of data for this model:
mydata<-list(y=y,n=length(y),N=120)
```


#### Write the model:
```{r}
model_1<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a0
  }
  # priors
  a0 ~ dnorm(0,0.1) # sd=10
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(a0 = -4)
init2 <- list(a0 = -3)
init3 <- list(a0 = -2)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("a0")
```

#### Fit the model with Jags
```{r}
model1_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_1,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```

```{r}
model1_fit
```
#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model1_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model1"
waic$prior<-"a0~ N(0,sd=10)"

# Save the result:
waic_save<-as.data.frame(waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```



### Model 1_bis
Y~ Poisson (T * u)
log (u) = a0 + log (A)
Prior:
  a0~ N(0,sd=10)
  
```{r}
#Create dataframe of data for this model:
A<-as.numeric(data$Area)
mydata<-list(y=y,n=length(y),N=120,A=A)
```


#### Write the model:
```{r}
model_1_bis<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a0 + log(A[i])
  }
  # priors
  a0 ~ dnorm(0,0.1) # sd=10
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(a0 = -4)
init2 <- list(a0 = -3)
init3 <- list(a0 = -2)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("a0")
```

#### Fit the model with Jags
```{r}
model1_bis_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_1_bis,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model1_bis_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model1_bis_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model1_bis"
waic$prior<-"a0~ N(0,sd=10)"
# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```





### Model 2
Y~ Poisson (T * u)
log (u) = a0 + a1 P 
Prior:
  a0~ N(0,sd=10)
  a1~ N(0,sd=10)
  
```{r}
#Create dataframe of data for this model:
mydata<-list(y=y,x=x,n=length(y),N=120)
```


#### Write the model:
```{r}
model_2<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a0 + a1*x[i]
  }
  # priors
  a0 ~ dnorm(0,0.1) # sd=10
  a1 ~ dnorm(0,0.1) 
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(a0 = -4,a1=0)
init2 <- list(a0 = -3,a1=1)
init3 <- list(a0 = -2,a1=-1)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("a0","a1")
```

#### Fit the model with Jags
```{r}
model2_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_2,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model2_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model2_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model2"
waic$prior<-"a0~ N(0,sd=10) / a1~ N(0,sd=10)"
# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```


### Model 2_bis
Y~ Poisson (T * u)
log (u) = a0 + a1 P + log(A)
Prior:
  a0~ N(0,sd=10)
  a1~ N(0,sd=10)
  
```{r}
#Create dataframe of data for this model:
A<-as.numeric(data$Area)
mydata<-list(y=y,x=x,n=length(y),N=120,A=A)
```


#### Write the model:
```{r}
model_2_bis<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a0 + a1*x[i]+ log(A[i])
  }
  # priors
  a0 ~ dnorm(0,0.1) # sd=10
  a1 ~ dnorm(0,0.1) 
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(a0 = -4,a1=0)
init2 <- list(a0 = -3,a1=1)
init3 <- list(a0 = -2,a1=-1)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("a0","a1")
```

#### Fit the model with Jags
```{r}
model2_bis_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_2_bis,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model2_bis_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model2_bis_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model2_bis"
waic$prior<-"a0~ N(0,sd=10) / a1~ N(0,sd=10)"
# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```


### Model 3
Y~ Poisson (T * u)
log (u) = a0 + Es 
Prior:
  a0~ N(0,sd=10)
  Es~ N(mu.es,tau.es) #tau.es = 1/variance=sigma.es²
      mu.es~N(0,sd=10)
      tau.es <- 1 / (sigma.es * sigma.es)
      sigma.es~Unif(0,100)
  
```{r}
#Create dataframe of data for this model:
A<-as.numeric(data$Area)
nbsites<-length(unique(data$Site))
sites<-as.numeric(data$Site)
mydata<-list(y=y,n=length(y),N=120,nbsites=nbsites,sites=sites)
```


#### Write the model:
```{r}
model_3<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a[sites[i]]  # + a1*x[i]
  }
  for(j in 1:nbsites){
    a[j] ~ dnorm(mu.a,tau.a)
  } # For random effect of site
  # priors
  #a ~ dnorm(0,0.1) # sd=10
  #a1 ~ dnorm(0,0.1)
  mu.a ~ dnorm(0,0.1)
  tau.a <- 1 / (sigma.a * sigma.a)
  sigma.a ~ dunif(0,100)
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(mu.a=1,sigma.a=0.5)
init2 <- list(mu.a=-3,sigma.a=1.5)
init3 <- list(mu.a=2,sigma.a=1)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("mu.a","sigma.a")
```

#### Fit the model with Jags
```{r}
model3_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_3,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model3_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model3_bis_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model3"
waic$prior<-" mu.a~N(0,sd=10) // tau.a <- 1 / (sigma.a * sigma.a) //sigma.a~Unif(0,100)"


# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```










### Model 3_bis
Y~ Poisson (T * u)
log (u) = a0 + Es + log(A)
Prior:
  a0~ N(0,sd=10)
  Es~ N(mu.es,tau.es) #tau.es = 1/variance=sigma.es²
      mu.es~N(0,sd=10)
      tau.es <- 1 / (sigma.es * sigma.es)
      sigma.es~Unif(0,100)
  
```{r}
#Create dataframe of data for this model:
A<-as.numeric(data$Area)
nbsites<-length(unique(data$Site))
sites<-as.numeric(data$Site)
mydata<-list(y=y,n=length(y),N=120,A=A,nbsites=nbsites,sites=sites)
```


#### Write the model:
```{r}
model_3_bis<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a[sites[i]] + log(A[i]) # + a1*x[i]
  }
  for(j in 1:nbsites){
    a[j] ~ dnorm(mu.a,tau.a)
  } # For random effect of site
  # priors
  #a ~ dnorm(0,0.1) # sd=10
  #a1 ~ dnorm(0,0.1)
  mu.a ~ dnorm(0,0.1)
  tau.a <- 1 / (sigma.a * sigma.a)
  sigma.a ~ dunif(0,100)
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(mu.a=1,sigma.a=0.5)
init2 <- list(mu.a=-3,sigma.a=1.5)
init3 <- list(mu.a=2,sigma.a=1)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("mu.a","sigma.a")
```

#### Fit the model with Jags
```{r}
model3_bis_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_3_bis,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model3_bis_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model3_bis_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model3_bis"
waic$prior<-" mu.a~N(0,sd=10) // tau.a <- 1 / (sigma.a * sigma.a) //sigma.a~Unif(0,100)"


# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```








### Model 4_bis
Y~ Poisson (T * u)
log (u) = a0 + Es + log(A)
Prior:
  a0~ N(0,sd=10)
  Es~ N(mu.es,tau.es) #tau.es = 1/variance=sigma.es²
      mu.es~N(0,sd=10)
      tau.es <- 1 / (sigma.es * sigma.es)
      sigma.es~Unif(0,100)
  
```{r}
#Create dataframe of data for this model:
A<-as.numeric(data$Area)
nbsites<-length(unique(data$Site))
sites<-as.numeric(data$Site)
mydata<-list(y=y,n=length(y),N=120,A=A,nbsites=nbsites,sites=sites)
```


#### Write the model:
```{r}
model_3_bis<-function(){
  # likelihood
  for(i in 1:n){
    y[i] ~ dpois(lambda[i]) #likelihood
    lambda[i]<-N*u[i]
    log(u[i]) <- a[sites[i]] + log(A[i]) # + a1*x[i]
  }
  for(j in 1:nbsites){
    a[j] ~ dnorm(mu.a,tau.a)
  } # For random effect of site
  # priors
  #a ~ dnorm(0,0.1) # sd=10
  #a1 ~ dnorm(0,0.1)
  mu.a ~ dnorm(0,0.1)
  tau.a <- 1 / (sigma.a * sigma.a)
  sigma.a ~ dunif(0,100)
}
```


#### Specify info to Jags
Initial values:
We specify the initial values for 3 markov chains:
```{r}
init1 <- list(mu.a=1,sigma.a=0.5)
init2 <- list(mu.a=-3,sigma.a=1.5)
init3 <- list(mu.a=2,sigma.a=1)
init <- list(init1,init2,init3)
```

Parameters to monitor :
```{r}
params <- c("mu.a","sigma.a")
```

#### Fit the model with Jags
```{r}
model3_bis_fit <- jags(data = mydata,
                             inits = init,
                             parameters.to.save = params,
                             model.file = model_3_bis,
                             n.chains = 3,
                             n.iter = 6000,
                             n.burnin = 3000,
                             n.thin = 1)
```



```{r}
model3_bis_fit
```

#### Assess convergence
Rhat
n.eff

#### Model selection: Compute WAIC criterion
```{r}
samples <- jags.samples(model3_bis_fit$model,c("WAIC","deviance"), type = "mean",
n.iter = 6000,
n.burnin = 3000,
n.thin = 1)
samples$p_waic <- samples$WAIC #number of parameters
# Calculate the true AIC:
samples$waic <- samples$deviance + samples$p_waic
tmp <- sapply(samples, sum)
waic <- round(c(waic = tmp[["waic"]], p_waic = tmp[["p_waic"]],deviance = tmp[["deviance"]]),1)
waic$Modelname<-"model3_bis"
waic$prior<-" mu.a~N(0,sd=10) // tau.a <- 1 / (sigma.a * sigma.a) //sigma.a~Unif(0,100)"


# Save the result:
waic<-as.data.frame(waic)
waic_save<-rbind(waic_save,waic)
                     
```
#### The results: look to posterior distributions

```{r}
# have a look to posterior distribution
hist(model1_fit$BUGSoutput$sims.matrix[,"a0"])
plot(density(model1_fit$BUGSoutput$sims.matrix[,"a0"]))
```






